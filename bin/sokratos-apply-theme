#!/usr/bin/env bash

# Check if the user provided an argument
if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <path_to_image>"
    exit 1
fi

IMAGE="$1"

# Set wallpaper
swww img "$IMAGE"

# Generate matugen colors
matugen image "$IMAGE"
sleep 0.4

pywalfox update

# Refresh swaync
pkill swaync
swaync > /dev/null 2>&1 &

# Refresh waybar
pkill waybar
waybar > /dev/null 2>&1 &

# Image analysis variables
PRIMARY_HEX=$(<~/.cache/matugen/primary-hex.txt)
COLOR1=$(pastel format name $PRIMARY_HEX)
SHADE=$(magick "$IMAGE" \
  -alpha remove -alpha off -colorspace Gray \
  -format "%[fx:mean]" info: | awk '{print ($1<0.35)?"dark":"light"}'
)

THEMES_DIR="$HOME/.local/share/sokratos/themes"
CURRENT_THEME_DIR="$HOME/.config/sokratos/current/theme/colors.conf"

set_theme() {
	local theme="$1"
	notify-send "$SHADE $COLOR1: $theme"
	ln -nsf "$THEMES_DIR/$theme/colors.conf" "$CURRENT_THEME_DIR"
}

# Change kitty pallete based on image analysis
case "$SHADE $COLOR1" in
  "dark lightsteelblue")  set_theme nord ;;
  "light lightsteelblue") set_theme tokyonight ;;

  # Shade-agnostic: any SHADE + color
  *" lightsalmon")        set_theme gruvbox ;;
  *" lightskyblue")       set_theme everforest ;;
  *" skyblue")            set_theme nord ;;
  *" plum")               set_theme catppuccin ;;
  *" powderblue")         set_theme everforest ;;
  *" darkkhaki")          set_theme rosepine ;;

  # Different theme per shade for same color
  "light lightpink")      set_theme rosepine ;;
  "dark lightpink")       set_theme nightfox ;;

  # Example: two different choices based on shade
  "light darkseagreen")   set_theme everforest ;;
  "dark darkseagreen")    set_theme gruvbox ;;

  # Fallback
  *) notify-send "$SHADE $COLOR1" && sokratos-themes &&  exit 0 ;;
esac

# Refresh kitty
pkill -SIGUSR1 kitty
